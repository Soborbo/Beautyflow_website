---
// Global GTM tracking for conversions
// Following analytics-measurement skill conventions
---

<script>
  function initGTMTracking() {
    // Ensure dataLayer exists
    window.dataLayer = window.dataLayer || [];

    // Track all phone clicks (conversion event)
    document.querySelectorAll('a[href^="tel:"]').forEach((link) => {
      link.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLAnchorElement;
        const location = target.closest('header') ? 'header'
          : target.closest('footer') ? 'footer'
          : target.closest('#sticky-cta') ? 'sticky_mobile'
          : target.closest('.hero') ? 'hero'
          : 'content';

        window.dataLayer.push({
          event: 'phone_click',
          click_location: location
        });
      });
    });

    // Track all WhatsApp clicks (conversion event)
    document.querySelectorAll('a[href*="wa.me"]').forEach((link) => {
      // Skip floating button (has its own tracking)
      if (link.id === 'whatsapp-btn') return;

      link.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLAnchorElement;
        const location = target.closest('header') ? 'header'
          : target.closest('footer') ? 'footer'
          : target.closest('.hero') ? 'hero'
          : 'content';

        window.dataLayer.push({
          event: 'whatsapp_click',
          click_location: location
        });
      });
    });

    // Track CTA button clicks (micro event)
    document.querySelectorAll('a[href*="konzultacio"], a[href*="consultation"], a[href*="notino"]').forEach((link) => {
      link.addEventListener('click', (e) => {
        const target = e.currentTarget as HTMLAnchorElement;
        const text = target.textContent?.trim().substring(0, 100) || '';
        const location = target.closest('header') ? 'header'
          : target.closest('footer') ? 'footer'
          : target.closest('.hero') ? 'hero'
          : target.closest('section')?.querySelector('h2')?.textContent?.trim().substring(0, 50) || 'content';

        window.dataLayer.push({
          event: 'cta_click',
          cta_location: location,
          cta_text: text
        });
      });
    });

    // Track form interactions
    const forms = document.querySelectorAll('form');
    forms.forEach((form) => {
      let formStarted = false;
      const formName = form.id || form.getAttribute('name') || 'contact';

      // Track form start on first interaction
      form.addEventListener('focusin', () => {
        if (!formStarted) {
          formStarted = true;
          window.dataLayer.push({
            event: 'form_start',
            form_name: formName
          });
        }
      }, { once: true });

      // Track form submit
      form.addEventListener('submit', () => {
        window.dataLayer.push({
          event: 'form_submit',
          form_name: formName,
          form_type: 'lead'
        });
      });
    });
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', initGTMTracking);
  document.addEventListener('astro:page-load', initGTMTracking);
</script>
