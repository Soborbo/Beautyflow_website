---
export const prerender = true;

import '../styles/global.css';
import { getImage } from 'astro:assets';

// Image imports
import lezeresImg from '../assets/images/lezeres-szortelenites-beautyflow-bg.jpg';
import hydraImg from '../assets/images/hydrabeauty-arckezeles.jpg';
import sminkImg from '../assets/images/sminktetovalas-budapest-beautyflow.jpg';
import carbonImg from '../assets/images/carbon-peeling-lezeres.jpg';
import tetovalasImg from '../assets/images/tetovalas-eltavolitas-budapest.jpg';
import pigmentImg from '../assets/images/pigmentfolt-eltavoitas.webp';
import googleLogo from '../assets/images/google-logo.jpg';

// Optimize images - 1x and 2x for retina displays, webp for broad support
// Card size is ~150-200px on mobile, ~180px on desktop, so 200px 1x + 400px 2x covers all cases
const treatmentImages = await Promise.all([
  { id: 'lezer', name: 'Dióda Lézeres Szőrtelenítés', src: lezeresImg },
  { id: 'hydra', name: 'HydraBeauty Arckezelés', src: hydraImg },
  { id: 'smink', name: 'Tartós Sminktetoválás', src: sminkImg },
  { id: 'carbon', name: 'Carbon Peeling', src: carbonImg },
  { id: 'tetovalas', name: 'Lézeres Tetoválás Eltávolítás', src: tetovalasImg },
  { id: 'pigment', name: 'Pigmentfolt Eltávolítás', src: pigmentImg },
].map(async (t) => {
  const img1x = await getImage({ src: t.src, width: 200, height: 200, format: 'webp', quality: 75 });
  const img2x = await getImage({ src: t.src, width: 400, height: 400, format: 'webp', quality: 70 });
  return { id: t.id, name: t.name, src1x: img1x.src, src2x: img2x.src };
}));

const googleLogoOptimized = await getImage({ src: googleLogo, width: 16, height: 16, format: 'webp', quality: 70 });

const lang = 'hu';
const canonicalUrl = 'https://beautyflow.pro/ingyenes-konzultacio';
const huUrl = '/ingyenes-konzultacio';
const enUrl = '/en/free-consultation';

const treatments = treatmentImages;

const socialProofs = [
  { name: 'Bátor Blanka', text: 'Teljes szívből ajánlom őket, profi munka, tündéri szakemberek!' },
  { name: 'Tóth Viola', text: 'A profizmus, kedvesség, igényesség mellett fantasztikus hatás, ami már az első kezelés után érezhető. Szívből ajánlom Fannit és az egész csapatát!' },
  { name: 'Szilágyi Sára', text: 'Kedves fogadtatás, szép és nyugodt környezet, részletes tájékoztatás a kezelésről. Nagyon meg vagyok elégedve!' },
  { name: 'Hajdu Tímea', text: 'A legjobb hely a dióda lézeres szőrtelenítéshez. Fanni és Piroska elképesztő, alapos munkát végeznek.' },
];

// Schema.org - ContactPoint for consultation
const contactSchema = {
  "@context": "https://schema.org",
  "@type": "BeautySalon",
  "name": "Beautyflow Szépségszalon",
  "url": "https://beautyflow.pro/ingyenes-konzultacio",
  "telephone": "+36 1 300 9414",
  "contactPoint": {
    "@type": "ContactPoint",
    "telephone": "+36 1 300 9414",
    "contactType": "Customer Service",
    "areaServed": "HU",
    "availableLanguage": ["Hungarian", "English"],
    "contactOption": "TollFree"
  },
  "address": [
    {
      "@type": "PostalAddress",
      "streetAddress": "Vegyész utca 1.",
      "addressLocality": "Budapest",
      "postalCode": "1116",
      "addressCountry": "HU"
    },
    {
      "@type": "PostalAddress",
      "streetAddress": "Reitter Ferenc utca 90.",
      "addressLocality": "Budapest",
      "postalCode": "1135",
      "addressCountry": "HU"
    }
  ]
};

// BreadcrumbList Schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Főoldal",
      "item": "https://beautyflow.pro"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Ingyenes Konzultáció",
      "item": "https://beautyflow.pro/ingyenes-konzultacio"
    }
  ]
};
---

<!DOCTYPE html>
<html lang="hu">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Kérj ingyenes konzultációt a Beautyflow szépségszalonban. Személyre szabott tanácsadás lézeres szőrtelenítés, arckezelés, sminktetoválás témában." />
    <link rel="icon" type="image/png" href="/images/Beautyflow-favicon.png" />
    <title>Ingyenes Konzultáció | Beautyflow Szépségszalon</title>
    <link rel="canonical" href={canonicalUrl} />
    <link rel="alternate" hreflang="hu" href={`https://beautyflow.pro${huUrl}`} />
    <link rel="alternate" hreflang="en" href={`https://beautyflow.pro${enUrl}`} />
    <link rel="alternate" hreflang="x-default" href={`https://beautyflow.pro${huUrl}`} />
    <script type="application/ld+json" set:html={JSON.stringify(contactSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
    <!-- Google Tag Manager -->
    <script is:inline>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-W8V3BVGD');</script>
  </head>
  <body class="bg-[#fdf8f6] min-h-[100dvh] md:h-screen md:overflow-hidden">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W8V3BVGD"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <main class="min-h-[100dvh] md:h-full py-4 md:py-0">
      <!-- Form Container -->
      <div id="form-container" class="min-h-[100dvh] md:h-full flex items-center justify-center px-4">
        <div class="w-full max-w-2xl">

          <!-- Progress Indicator -->
          <div id="progress" class="flex justify-center gap-2 mb-4 md:mb-3">
            <div class="progress-dot w-3 h-3 rounded-full bg-[#c53f75] transition-all duration-300" data-step="1"></div>
            <div class="progress-dot w-3 h-3 rounded-full bg-gray-300 transition-all duration-300" data-step="2"></div>
            <div class="progress-dot w-3 h-3 rounded-full bg-gray-300 transition-all duration-300" data-step="3"></div>
            <div class="progress-dot w-3 h-3 rounded-full bg-gray-300 transition-all duration-300" data-step="4"></div>
          </div>

          <!-- Form Card -->
          <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-5 md:p-6 relative overflow-hidden">

            <!-- Step 1: Treatment Selection -->
            <div id="step-1" class="step-content" data-step="1">
              <div class="text-center mb-3">
                <h1 class="font-heading text-2xl sm:text-3xl md:text-2xl text-gray-900 uppercase">
                  Melyik kezelés érdekel?
                </h1>
              </div>

              <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-3 mb-3">
                {treatments.map((treatment, index) => (
                  <label
                    class="treatment-card group cursor-pointer relative rounded-xl overflow-hidden border-2 border-gray-200 hover:border-[#c53f75]/50 transition-all duration-300"
                    style={`animation-delay: ${index * 80}ms`}
                  >
                    <input
                      type="checkbox"
                      name="treatments"
                      value={treatment.id}
                      class="sr-only treatment-checkbox"
                    />
                    <div class="aspect-square overflow-hidden">
                      <img
                        src={treatment.src1x}
                        srcset={`${treatment.src1x} 1x, ${treatment.src2x} 2x`}
                        alt={treatment.name}
                        width="200"
                        height="200"
                        class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                        loading="lazy"
                        decoding="async"
                      />
                    </div>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>
                    <div class="absolute bottom-0 left-0 right-0 p-2 md:p-2">
                      <p class="text-white text-xs font-semibold leading-tight text-center">{treatment.name}</p>
                    </div>
                    <!-- Checkmark overlay -->
                    <div class="checkmark-overlay absolute inset-0 bg-[#c53f75]/20 opacity-0 transition-opacity duration-300 flex items-center justify-center">
                      <div class="w-10 h-10 sm:w-12 sm:h-12 bg-[#c53f75] rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 sm:w-7 sm:h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                        </svg>
                      </div>
                    </div>
                    <!-- Selected border -->
                    <div class="selected-border absolute inset-0 border-4 border-[#c53f75] rounded-xl opacity-0 transition-opacity duration-300 pointer-events-none"></div>
                  </label>
                ))}
              </div>

              <button
                id="btn-step-1"
                type="button"
                disabled
                class="w-full py-3 md:py-3 bg-[#c53f75] text-white font-semibold uppercase tracking-wide rounded-full hover:bg-[#a33460] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-[#c53f75]"
              >
                Tovább
              </button>

              <!-- Social Proof -->
              <div class="mt-3 pt-3 border-t border-gray-100 text-center -mb-4 sm:-mb-5 md:-mb-6">
                <div class="flex items-center justify-center gap-1 mb-2">
                  <img src={googleLogoOptimized.src} alt="Google" class="w-4 h-4 rounded-full" width="16" height="16" />
                  <div class="flex">
                    {[1,2,3,4,5].map(() => (
                      <svg class="w-3 h-3 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                      </svg>
                    ))}
                  </div>
                </div>
                <p class="text-gray-600 text-xs italic line-clamp-1">"{socialProofs[0].text}"</p>
                <p class="text-gray-500 text-xs -mt-2.5">– {socialProofs[0].name}</p>
              </div>
            </div>

            <!-- Step 2: Name -->
            <div id="step-2" class="step-content hidden" data-step="2">
              <div class="text-center mb-6">
                <h1 class="font-heading text-2xl sm:text-3xl md:text-2xl text-gray-900 uppercase">
                  Mi a neved?
                </h1>
              </div>

              <div class="space-y-4 mb-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label for="lastName" class="block text-sm font-medium text-gray-700 mb-1">Vezetéknév *</label>
                    <input
                      type="text"
                      id="lastName"
                      name="lastName"
                      required
                      autocomplete="family-name"
                      class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-[#c53f75] focus:outline-none transition-colors"
                      placeholder="pl. Kovács"
                    />
                  </div>
                  <div>
                    <label for="firstName" class="block text-sm font-medium text-gray-700 mb-1">Keresztnév *</label>
                    <input
                      type="text"
                      id="firstName"
                      name="firstName"
                      required
                      autocomplete="given-name"
                      class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-[#c53f75] focus:outline-none transition-colors"
                      placeholder="pl. Anna"
                    />
                  </div>
                </div>
              </div>

              <div class="flex gap-3">
                <button
                  type="button"
                  class="back-btn px-5 py-3 text-gray-600 font-medium hover:text-[#c53f75] transition-colors"
                >
                  Vissza
                </button>
                <button
                  id="btn-step-2"
                  type="button"
                  disabled
                  class="flex-1 py-3 bg-[#c53f75] text-white font-semibold uppercase tracking-wide rounded-full hover:bg-[#a33460] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Tovább
                </button>
              </div>

              <!-- Social Proof -->
              <div class="mt-8 pt-4 border-t border-gray-100 text-center">
                <div class="flex items-center justify-center gap-1 mb-2">
                  <img src={googleLogoOptimized.src} alt="Google" class="w-4 h-4 rounded-full" width="16" height="16" />
                  <div class="flex">
                    {[1,2,3,4,5].map(() => (
                      <svg class="w-3 h-3 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                      </svg>
                    ))}
                  </div>
                </div>
                <p class="text-gray-600 text-xs italic line-clamp-1">"{socialProofs[1].text}"</p>
                <p class="text-gray-500 text-xs -mt-2.5">– {socialProofs[1].name}</p>
              </div>
            </div>

            <!-- Step 3: Phone -->
            <div id="step-3" class="step-content hidden" data-step="3">
              <div class="text-center mb-6">
                <h1 class="font-heading text-2xl sm:text-3xl md:text-2xl text-gray-900 uppercase">
                  Mi a telefonszámod?
                </h1>
              </div>

              <div class="mb-6">
                <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">Telefonszám *</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  required
                  autocomplete="tel"
                  class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-[#c53f75] focus:outline-none transition-colors text-lg"
                  placeholder="+36 30 123 4567"
                />
              </div>

              <div class="flex gap-3">
                <button
                  type="button"
                  class="back-btn px-5 py-3 text-gray-600 font-medium hover:text-[#c53f75] transition-colors"
                >
                  Vissza
                </button>
                <button
                  id="btn-step-3"
                  type="button"
                  disabled
                  class="flex-1 py-3 bg-[#c53f75] text-white font-semibold uppercase tracking-wide rounded-full hover:bg-[#a33460] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                >
                  Tovább
                </button>
              </div>

              <!-- Social Proof -->
              <div class="mt-8 pt-4 border-t border-gray-100 text-center">
                <div class="flex items-center justify-center gap-1 mb-2">
                  <img src={googleLogoOptimized.src} alt="Google" class="w-4 h-4 rounded-full" width="16" height="16" />
                  <div class="flex">
                    {[1,2,3,4,5].map(() => (
                      <svg class="w-3 h-3 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                      </svg>
                    ))}
                  </div>
                </div>
                <p class="text-gray-600 text-xs italic line-clamp-1">"{socialProofs[2].text}"</p>
                <p class="text-gray-500 text-xs -mt-2.5">– {socialProofs[2].name}</p>
              </div>
            </div>

            <!-- Step 4: Email + Consent -->
            <div id="step-4" class="step-content hidden" data-step="4">
              <div class="text-center mb-6">
                <h1 class="font-heading text-2xl sm:text-3xl md:text-2xl text-gray-900 uppercase">
                  Mi az email címed?
                </h1>
              </div>

              <div class="space-y-4 mb-6">
                <div>
                  <label for="email" class="block text-sm font-medium text-gray-700 mb-1">Email cím *</label>
                  <input
                    type="email"
                    id="email"
                    name="email"
                    required
                    autocomplete="email"
                    class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-xl focus:border-[#c53f75] focus:outline-none transition-colors"
                    placeholder="pelda@email.hu"
                  />
                </div>

                <div class="flex items-start gap-3 mt-3">
                  <input
                    type="checkbox"
                    id="consent"
                    name="consent"
                    required
                    class="mt-0.5 w-5 h-5 text-[#c53f75] border-gray-300 rounded focus:ring-[#c53f75] cursor-pointer accent-[#c53f75]"
                  />
                  <label for="consent" class="text-sm text-gray-600 cursor-pointer">
                    Elfogadom az <a href="/adatvedelmi-tajekoztato" target="_blank" class="text-[#c53f75] underline hover:text-[#a33460]">adatvédelmi szabályzatot</a> *
                  </label>
                </div>
              </div>

              <!-- Honeypot field (hidden) -->
              <input type="text" name="website" class="hidden" tabindex="-1" autocomplete="off" />

              <div class="flex gap-3">
                <button
                  type="button"
                  class="back-btn px-5 py-3 text-gray-600 font-medium hover:text-[#c53f75] transition-colors"
                >
                  Vissza
                </button>
                <button
                  id="btn-submit"
                  type="button"
                  disabled
                  class="flex-1 py-3 bg-[#c53f75] text-white font-semibold uppercase tracking-wide rounded-full hover:bg-[#a33460] transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-sm"
                >
                  Kérem az ingyenes konzultációt
                </button>
              </div>

              <!-- Social Proof -->
              <div class="mt-8 pt-4 border-t border-gray-100 text-center">
                <div class="flex items-center justify-center gap-1 mb-2">
                  <img src={googleLogoOptimized.src} alt="Google" class="w-4 h-4 rounded-full" width="16" height="16" />
                  <div class="flex">
                    {[1,2,3,4,5].map(() => (
                      <svg class="w-3 h-3 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                      </svg>
                    ))}
                  </div>
                </div>
                <p class="text-gray-600 text-xs italic line-clamp-1">"{socialProofs[3].text}"</p>
                <p class="text-gray-500 text-xs -mt-2.5">– {socialProofs[3].name}</p>
              </div>
            </div>

            <!-- Thank You -->
            <div id="thank-you" class="step-content hidden text-center py-4 md:py-6">
              <div class="w-16 h-16 md:w-20 md:h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce-once">
                <svg class="w-8 h-8 md:w-10 md:h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7" />
                </svg>
              </div>
              <h1 class="font-heading text-2xl md:text-2xl text-gray-900 mb-2 uppercase">
                Köszönjük az érdeklődést!
              </h1>
              <p class="text-gray-600 mb-3 text-base">
                Hamarosan jelentkezünk a megadott elérhetőségeiden.
              </p>
              <p class="text-gray-500 text-sm mb-4">
                Sürgős ügyekben a <a href="tel:+3613009414" class="text-[#c53f75] font-semibold">+36 1 300 9414</a> telefonszámon is elérsz bennünket.
              </p>
              <a
                href="/"
                class="inline-block px-6 py-2.5 bg-[#c53f75] text-white font-semibold uppercase tracking-wide rounded-full hover:bg-[#a33460] transition-all duration-300"
              >
                Vissza a főoldalra
              </a>
            </div>

            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden absolute inset-0 bg-white/90 flex items-center justify-center z-50 rounded-2xl">
              <div class="flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-[#c53f75] border-t-transparent rounded-full animate-spin"></div>
                <p class="mt-4 text-gray-600">Küldés folyamatban...</p>
              </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden absolute bottom-4 left-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg z-50">
              <p id="error-text">Hiba történt, kérjük próbáld újra.</p>
            </div>

          </div>
        </div>
      </div>
    </main>

    <style>
      /* Step animations */
      .step-content {
        animation: fadeIn 0.3s ease-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* Treatment card animations */
      .treatment-card {
        animation: cardFadeIn 0.4s ease-out backwards;
      }

      @keyframes cardFadeIn {
        from {
          opacity: 0;
          transform: scale(0.9);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      /* Selected treatment state */
      .treatment-checkbox:checked ~ .checkmark-overlay {
        opacity: 1;
      }

      .treatment-checkbox:checked ~ .selected-border {
        opacity: 1;
      }

      /* Bounce animation for success icon */
      @keyframes bounceOnce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
      }

      .animate-bounce-once {
        animation: bounceOnce 0.5s ease-out;
      }

      /* Focus styles */
      input:focus {
        box-shadow: 0 0 0 3px rgba(197, 63, 117, 0.1);
      }
    </style>

    <script>
      import {
        persistTrackingParams,
        trackFullConversion,
        getAllTrackingData,
        hasMarketingConsent,
        onConsentChange,
        pushStepEvent,
      } from '../lib/tracking';

      // Initialize tracking on page load
      function initTracking() {
        // Consent listener - save tracking params when consent granted
        onConsentChange((consent) => {
          if (consent.marketing) {
            persistTrackingParams();
          }
        });

        // If consent already granted, save immediately
        if (hasMarketingConsent()) {
          persistTrackingParams();
        }
      }

      // Send tracking beacon (guaranteed delivery)
      function sendTrackingBeacon(data: Record<string, unknown>): void {
        const endpoint = '/api/tracking-beacon';

        try {
          const payload = JSON.stringify({
            ...data,
            timestamp: new Date().toISOString(),
            url: window.location.href,
            userAgent: navigator.userAgent,
          });

          if (navigator.sendBeacon) {
            const blob = new Blob([payload], { type: 'application/json' });
            navigator.sendBeacon(endpoint, blob);
          } else {
            fetch(endpoint, {
              method: 'POST',
              body: payload,
              headers: { 'Content-Type': 'application/json' },
              keepalive: true,
            }).catch(() => {});
          }
        } catch {}
      }

      // Generate transaction ID
      function generateTransactionId(): string {
        const timestamp = Date.now().toString(36);
        const random = Math.random().toString(36).slice(2, 7);
        return `LEAD-${timestamp}-${random}`.toUpperCase();
      }

      document.addEventListener('DOMContentLoaded', () => {
        // Initialize tracking
        initTracking();

        let currentStep = 1;

        // Form data
        const formData: {
          treatments: string[];
          firstName: string;
          lastName: string;
          phone: string;
          email: string;
          consent: boolean;
          website: string;
        } = {
          treatments: [],
          firstName: '',
          lastName: '',
          phone: '',
          email: '',
          consent: false,
          website: ''
        };

        // Elements
        const steps = document.querySelectorAll('.step-content');
        const progressDots = document.querySelectorAll('.progress-dot');
        const treatmentCheckboxes = document.querySelectorAll('.treatment-checkbox') as NodeListOf<HTMLInputElement>;
        const btnStep1 = document.getElementById('btn-step-1') as HTMLButtonElement;
        const btnStep2 = document.getElementById('btn-step-2') as HTMLButtonElement;
        const btnStep3 = document.getElementById('btn-step-3') as HTMLButtonElement;
        const btnSubmit = document.getElementById('btn-submit') as HTMLButtonElement;
        const backButtons = document.querySelectorAll('.back-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        // Input elements
        const firstNameInput = document.getElementById('firstName') as HTMLInputElement;
        const lastNameInput = document.getElementById('lastName') as HTMLInputElement;
        const phoneInput = document.getElementById('phone') as HTMLInputElement;
        const emailInput = document.getElementById('email') as HTMLInputElement;
        const consentInput = document.getElementById('consent') as HTMLInputElement;
        const honeypotInput = document.querySelector('input[name="website"]') as HTMLInputElement;

        // Show/hide steps
        function showStep(step: number) {
          steps.forEach(s => s.classList.add('hidden'));
          const targetStep = document.getElementById(`step-${step}`);
          if (targetStep) {
            targetStep.classList.remove('hidden');
          }

          // Update progress dots
          progressDots.forEach((dot, index) => {
            if (index < step) {
              dot.classList.remove('bg-gray-300');
              dot.classList.add('bg-[#c53f75]');
            } else {
              dot.classList.add('bg-gray-300');
              dot.classList.remove('bg-[#c53f75]');
            }
          });

          currentStep = step;
        }

        // Step 1: Treatment selection
        treatmentCheckboxes.forEach(checkbox => {
          checkbox.addEventListener('change', () => {
            formData.treatments = Array.from(treatmentCheckboxes)
              .filter(cb => cb.checked)
              .map(cb => cb.value);
            btnStep1.disabled = formData.treatments.length === 0;
          });
        });

        btnStep1.addEventListener('click', () => {
          if (formData.treatments.length > 0) {
            pushStepEvent('treatments', 1);
            showStep(2);
          }
        });

        // Step 2: Name validation
        function validateStep2() {
          const firstName = firstNameInput.value.trim();
          const lastName = lastNameInput.value.trim();
          btnStep2.disabled = !(firstName.length >= 2 && lastName.length >= 2);
        }

        firstNameInput.addEventListener('input', () => {
          formData.firstName = firstNameInput.value.trim();
          validateStep2();
        });

        lastNameInput.addEventListener('input', () => {
          formData.lastName = lastNameInput.value.trim();
          validateStep2();
        });

        btnStep2.addEventListener('click', () => {
          if (formData.firstName.length >= 2 && formData.lastName.length >= 2) {
            pushStepEvent('name', 2);
            showStep(3);
          }
        });

        // Step 3: Phone validation
        function validatePhone(phone: string): boolean {
          const cleaned = phone.replace(/[\s\-\(\)]/g, '');
          const patterns = [
            /^\+36[0-9]{9}$/,
            /^06[0-9]{9}$/,
            /^[0-9]{9}$/,
            /^36[0-9]{9}$/
          ];
          return patterns.some(p => p.test(cleaned));
        }

        phoneInput.addEventListener('input', () => {
          formData.phone = phoneInput.value.trim();
          btnStep3.disabled = !validatePhone(formData.phone);
        });

        btnStep3.addEventListener('click', () => {
          if (validatePhone(formData.phone)) {
            pushStepEvent('phone', 3);
            showStep(4);
          }
        });

        // Step 4: Email + Consent validation
        function validateEmail(email: string): boolean {
          const pattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return pattern.test(email);
        }

        function validateStep4() {
          const emailValid = validateEmail(formData.email);
          const consentGiven = formData.consent;
          btnSubmit.disabled = !(emailValid && consentGiven);
        }

        emailInput.addEventListener('input', () => {
          formData.email = emailInput.value.trim();
          validateStep4();
        });

        // Auto-correct common email typos on blur
        emailInput.addEventListener('blur', () => {
          let email = emailInput.value.trim();
          // Fix common typos
          const typoCorrections: Record<string, string> = {
            'gmail.hu': 'gmail.com',
            'gmail.co': 'gmail.com',
            'gmial.com': 'gmail.com',
            'gmal.com': 'gmail.com',
            'hotmail.hu': 'hotmail.com',
            'yahoo.hu': 'yahoo.com',
            'outlook.hu': 'outlook.com',
          };

          for (const [typo, correction] of Object.entries(typoCorrections)) {
            if (email.endsWith('@' + typo)) {
              email = email.replace('@' + typo, '@' + correction);
              emailInput.value = email;
              formData.email = email;
              validateStep4();
              break;
            }
          }
        });

        consentInput.addEventListener('change', () => {
          formData.consent = consentInput.checked;
          validateStep4();
        });

        // Back buttons
        backButtons.forEach(btn => {
          btn.addEventListener('click', () => {
            if (currentStep > 1) {
              showStep(currentStep - 1);
            }
          });
        });

        // Submit
        btnSubmit.addEventListener('click', async () => {
          formData.website = honeypotInput?.value || '';
          if (formData.website) {
            showThankYou();
            return;
          }

          loadingOverlay?.classList.remove('hidden');
          errorMessage?.classList.add('hidden');

          // Generate transaction ID for tracking
          const transactionId = generateTransactionId();

          // Track conversion (GTM + Zaraz) - consent-aware
          const trackingResult = trackFullConversion({
            email: formData.email,
            phone: formData.phone,
            firstName: formData.firstName,
            lastName: formData.lastName,
            value: 5000, // Lead value in HUF
            currency: 'HUF',
            transactionId,
            contentName: 'Ingyenes Konzultáció',
          });

          // Get all tracking data for beacon
          const trackingData = getAllTrackingData();

          // Send beacon (guaranteed delivery even on page unload)
          sendTrackingBeacon({
            email: formData.email,
            phone: formData.phone,
            transactionId,
            gclid: trackingResult.gclid,
            fbclid: trackingResult.fbclid,
            ...trackingData,
          });

          try {
            const response = await fetch('/api/contact', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(formData),
            });

            const result = await response.json();

            if (result.success) {
              showThankYou();
            } else {
              showError(result.error || 'Hiba történt, kérjük próbáld újra.');
            }
          } catch (error) {
            showError('Hiba történt a küldés során. Kérjük próbáld újra később.');
          } finally {
            loadingOverlay?.classList.add('hidden');
          }
        });

        function showThankYou() {
          steps.forEach(s => s.classList.add('hidden'));
          document.getElementById('thank-you')?.classList.remove('hidden');
          document.getElementById('progress')?.classList.add('hidden');
        }

        function showError(message: string) {
          if (errorText) errorText.textContent = message;
          errorMessage?.classList.remove('hidden');
          setTimeout(() => {
            errorMessage?.classList.add('hidden');
          }, 5000);
        }
      });
    </script>
  </body>
</html>
